Data Science Specilization
==========================

Generated on `r as.character(Sys.time())`.

Generated by `r R.version$version.string` on `r R.version$os`.

Getting and Cleaning - Final Course Project
-------------------------------------------

Initial Preperation
-------------------

Load any dependant packages and set the working directory

```{r}
if(!require(data.table)) {
      install.packages("data.table")
      library(data.table)
}

path <- getwd()

```

Prepare the core dataset
------------------------

Create a new folder called `data` if it doesn't already exist:

```{r}
if(!dir.exists('data')){
      dir.create('data')
}
datapath <- file.path(getwd(), "data")
datapath
```

Download the data set into the `data` directory if the data doesn't already exist.

```{r}

fileURL <- "https://d396qusza40orc.cloudfront.net/getdata%2Fprojectfiles%2FUCI%20HAR%20Dataset.zip"
filename <- file.path(datapath, "ActivityData.zip")
if(!file.exists(filename)){
     download.file(fileURL, filename)
}
```

Unzip the file:

```{r}
unzip(filename, exdir=datapath)
```

Resultant data files needed are in `r file.path(datapath, 'UCI HAR Dataset')`. Set a variable called `activitydata' to the correct path.

```{r}
activitdata <- file.path(datapath, "UCI HAR Dataset")
activitdata
```

Load the base data
------------------

```{r}
dtSubjectTrainData <- fread(file.path(activitdata, "train", "subject_train.txt"))
dtActivityLabelTrainData <- fread(file.path(activitdata, "train", "Y_train.txt"))
dtTrainData <- read.table(file.path(activitdata, "train", "X_train.txt"))

dtSubjectTestData <- fread(file.path(activitdata, "test", "subject_test.txt"))
dtActivityLabelTestData <- fread(file.path(activitdata, "test", "Y_test.txt"))
dtTestData <- read.table(file.path(activitdata, "test", "X_test.txt"))
```

Performance basic sanity. Each of the Train and Test files should equal the same length.

```{r}
trainDataOK <- assertthat::are_equal(length(dtSubjectTestData), length(dtActivityLabelTestData), length(dtTestData))
testDataOK <- assertthat::are_equal(length(dtSubjectTrainData), length(dtActivityLabelTrainData), length(dtTrainData))

if(trainDataOK & testDataOK)
{
      'Data OK'
}else{
      'Data not OK. Exiting'
      stop()
}
```

Merge the core data into a new set of tables
--------------------------------------------

Row Bind (with rbind) the Training and Test sets for both Subject and Activity.

```{r}
dtCoreSubject <- rbind(dtSubjectTrainData, dtSubjectTestData)
dtCoreActivity <- rbind(dtActivityLabelTrainData, dtActivityLabelTestData)
dtCore <- rbind(dtTrainData, dtTestData)
```

Clean up the table column names to something more sensible:

```{r}
setnames(dtCoreSubject, "V1", "subject")
setnames(dtCoreActivity, "V1", "activityid")
```

Merge all the columns together

```{r}
dtCoreSubject <- cbind(dtCoreSubject, dtCoreActivity)
dtCore <- cbind(dtCoreSubject, dtCore)
```

Set a key on subject and activityid for future analysis.

```{r}
setkey(dtCore, subject, activityid)
```

Isolate the mean/stddev columns
-------------------------------

We can use `features.txt` to find out the columns that are related to mean and stdev.

Load in the `features.txt` file, and give the data table some friendly column names

```{r}
dtFeatureNames <- read.table(file.path(activitdata, "features.txt"))
setnames(dtFeatureNames, names(dtFeatureNames), c("featureid", "featurename"))
head(dtFeatureNames)
```

Find all mean and stddev fields (indicatd by mean or std in featurename column)
using `grepl`.

```{r}
dtFeatureNamesFiltered <- dtFeatureNames[grepl("mean\\(\\)|std\\(\\)", dtFeatureNames$featurename),]
head(dtFeatureNamesFiltered)
```

The dtCore table has column names of V1, V2 etc. Using the index of the mean/std
columns from dtFeatureNames we can identify the columns in dtCore that we 
require for the new tidy dataset.

```{r}
dtFeatureNamesFiltered$featureidx <- paste0("V", dtFeatureNamesFiltered[,1])
dtCleanCore <- dtCore[, c(key(dtCore), dtFeatureNamesFiltered$featureidx), with=FALSE]
```

Clean up tidy data table
------------------------

First, we need to give our columns friendly names. These are in the `activity_labels.txt` file.

Load the file, and parse out the activity labels

```{r}
dtActivityLabels <- fread(file.path(activitdata, "activity_labels.txt"))
setnames(dtActivityLabels, c("activityid", "activityname"))
head(dtActivityLabels)
```

Let's update our dtCleanCore with the Activity Labels. Because we named the activityid column the same in both data tables, we can use the simple merge method. Set `all.x=TRUE`
in case we find a row that doesn't have a matching label.

```{r}
dtCleanCore <- merge(dtActivityLabels,dtCleanCore, by="activityid", all.x=TRUE)
```

Remove our activityid as we don't need it anymore

```{r}
dtCleanCore$activityid <- NULL
names(dtCleanCore)
```


Rename the columns to something more useful.

Use Grep/Rename to create useful names. For example 
* ^t = Time_
* ^f = Frequency_
* Acc = Acceleration
* Mag = Magnitude
* -mean() = Mean
* -std() = StandardDeviation
* tBodyGyro = TimeBodyGyro
* tGravityAcc = TimeGravityAcceleration

```{r}

dtFeatureNamesFiltered[,2] <- gsub("Acc", "Acceleration", dtFeatureNamesFiltered[,2])
dtFeatureNamesFiltered[,2] <- gsub("Mag", "Magnitude", dtFeatureNamesFiltered[,2])
dtFeatureNamesFiltered[,2] <- gsub("-mean\\(\\)", "Mean", dtFeatureNamesFiltered[,2])
dtFeatureNamesFiltered[,2] <- gsub("-std\\(\\)", "StandardDiv", dtFeatureNamesFiltered[,2])
dtFeatureNamesFiltered[,2] <- gsub("^t", "Time", dtFeatureNamesFiltered[,2])
dtFeatureNamesFiltered[,2] <- gsub("^f", "Freq", dtFeatureNamesFiltered[,2])

setnames(dtCleanCore, grep("V", names(dtCleanCore), value = TRUE), as.vector(dtFeatureNamesFiltered[,2]))
names(dtCleanCore)
```

Create the new aggregate tidy data set
--------------------------------------

Let's aggregate our data set and clean up some of the new columns

```{r warning=FALSE}
dtTidyAggregate <- aggregate(dtCleanCore, by=list(dtCleanCore$subject, dtCleanCore$activityname), FUN=mean, na.rm=TRUE)
dtTidyAggregate$Group.1 <- NULL
dtTidyAggregate$activityname <- NULL
names(dtTidyAggregate)[names(dtTidyAggregate)=="Group.2"] <- "activityname"
dtTidyAggregate <- dtTidyAggregate
```

Re-order the first two columns

```{r}
dtTidyAggregate <- as.data.table(cbind(subject = dtTidyAggregate$subject, activityname = dtTidyAggregate$activityname, dtTidyAggregate[,-(dtTidyAggregate$subject)]))
names(dtTidyAggregate)
```

Add mean to all of the value columns to indicate that they are now all mean values for the subject and activity type:

```{r}
dtNewTidyVarNames <- paste0("Mean-", names(dtTidyAggregate[, !c("subject", "activityname"), with=FALSE]))
colnames(dtTidyAggregate)[c(-1,-2)] <- dtNewTidyVarNames
```

Generate the codebook

```{r}
knit("codebook.Rmd", quiet = TRUE, output = NULL)
markdownToHTML("codebook.md", "codebook.html")
```